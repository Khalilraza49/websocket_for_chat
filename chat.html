<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Client</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        #sender-id { width: 70%; padding: 8px; }
        #receiver-id { width: 70%; padding: 8px; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .sent { background: #e3f2fd; text-align: right; }
        .received { background: #f1f1f1; }
        .media { max-width: 200px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket Chat</h1>
    <div id="chat-box"></div>
    <input type="text" id="sender-id" placeholder="sender id">
    <input type="text" id="receiver-id" placeholder="receiver id">
    <input type="text" id="message-input" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
    <input type="file" id="file-input" style="display: none;">
    <button onclick="document.getElementById('file-input').click()">Send File</button>

    <script>
        // Replace with your actual JWT token from PHP login
        const JWT_TOKEN = "90c04994-b3d4-4663-9f75-d6733e40cc47";
        // Replace with your EC2 IP and WebSocket port
        const socket = io('http://107.22.158.136:5000', {
            query: {
                token: JWT_TOKEN
            }
        });

        // DOM elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const currentUserId = () => document.getElementById('sender-id').value.trim();
        const recipientId = () => document.getElementById('receiver-id').value.trim();
        const fileInput = document.getElementById('file-input');

        // // Current user and recipient IDs (replace with actual values)
        // const currentUserId = sender_id; // Get this from your PHP session
        // const recipientId = receiver_id;   // The user you're chatting with

        // Connection events
        socket.on('connect', () => {
            addMessage("System", "Connected to chat server", "system");
        });
	socket.emit('join', { user_id: currentUserId() });
        socket.emit('join', { user_id: recipientId() });
        socket.on('disconnect', () => {
            addMessage("System", "Disconnected from server", "system");
        });
        socket.on('connect_error', (err) => {
            console.error('Connection error:', err.message);
        });
        // Message events
        socket.on('receive_message', (message) => {
            if (message.sender_id == recipientId) {
                const isMedia = message.content.startsWith('http');
                addMessage(
                    `User ${message.sender_id}`,
                    message.content,
                    "received",
                    isMedia ? message : null
                );
            }
        });

        socket.on('message_sent', (message) => {
            const isMedia = message.content.startsWith('http');
            addMessage(
                "You",
                message.content,
                "sent",
                isMedia ? message : null
            );
        });

        // File upload handler
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const formData = new FormData();
                formData.append('file', file);

                // Upload to your PHP endpoint
                const response = await fetch('https://takavitutors.com/api/v1/upload-chat-files', {
                    method: 'POST',
                    headers: {
                        'x-api-key': '90c04994-b3d4-4663-9f75-d6733e40cc47'
                    },
                    body: formData
                });

                const result = await response.json();
                const sender = currentUserId();
                const receiver = recipientId();
                if (result.status === 'success') {
                    // Send via WebSocket
                    socket.emit('send_message', {
                        receiver_id: receiver,
                        sender_id:sender,
                        content: result.url,
                        attachment_name: result.name,
                        file_ext: result.extension,
                        mime_type: result.type
                    });
                }
            } catch (error) {
                console.error('Upload failed:', error);
                addMessage("System", "File upload failed", "error");
            }
        });

        // Send text message
        function sendMessage() {
            const sender = currentUserId();
            const receiver = recipientId();
            const message = messageInput.value.trim();

            if (!sender || !receiver) {
                alert("Sender and Receiver IDs are required.");
                return;
            }

            if (message) {
                socket.emit('send_message', {
                    receiver_id: receiver,
                    sender_id: sender,
                    content: message,
                });
                alert("Message sent");
                messageInput.value = '';
            }
        }

        // Add message to chat box
        function addMessage(sender, content, type, mediaData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const senderSpan = document.createElement('span');
            senderSpan.style.fontWeight = 'bold';
            senderSpan.textContent = `${sender}: `;
            
            const contentSpan = document.createElement('span');
            contentSpan.textContent = content;
            
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(contentSpan);

            if (mediaData) {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = 'media';
                
                if (mediaData.mime_type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = mediaData.content;
                    img.style.maxWidth = '100%';
                    mediaDiv.appendChild(img);
                } else if (mediaData.mime_type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = mediaData.content;
                    video.controls = true;
                    video.style.maxWidth = '100%';
                    mediaDiv.appendChild(video);
                } else {
                    const link = document.createElement('a');
                    link.href = mediaData.content;
                    link.textContent = mediaData.attachment_name;
                    link.target = '_blank';
                    mediaDiv.appendChild(link);
                }
                
                messageDiv.appendChild(mediaDiv);
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Send on Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
